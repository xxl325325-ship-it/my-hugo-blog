name: å®šæ—¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

on:
  schedule:
    # æ¯å¤©12ç‚¹å’Œ0ç‚¹è¿è¡Œ (UTCæ—¶é—´)
    # åŒ—äº¬æ—¶é—´ 12:00 = UTC 04:00
    # åŒ—äº¬æ—¶é—´ 00:00 = UTC 16:00 (å‰ä¸€å¤©)
    - cron: '0 4,16 * * *'
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'éƒ¨ç½²è¯´æ˜'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘çš„å®šæ—¶éƒ¨ç½²'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: è®¾ç½® Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.149.0'
        extended: true
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ›´æ”¹
      id: check_changes
      run: |
        # è·å–ä¸Šæ¬¡éƒ¨ç½²åçš„æ›´æ”¹
        if [ "${{ github.event_name }}" = "schedule" ]; then
          # æ£€æŸ¥è¿‡å»12å°æ—¶å†…æ˜¯å¦æœ‰æäº¤
          RECENT_COMMITS=$(git log --since="12 hours ago" --oneline | wc -l)
          if [ $RECENT_COMMITS -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“Š å‘ç° $RECENT_COMMITS ä¸ªæ–°æäº¤ï¼Œå°†æ‰§è¡Œéƒ¨ç½²"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ è¿‡å»12å°æ—¶å†…æ— æ–°æäº¤ï¼Œè·³è¿‡éƒ¨ç½²"
          fi
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸš€ æ‰‹åŠ¨è§¦å‘ï¼Œæ‰§è¡Œéƒ¨ç½²"
        fi
        
    - name: æ„å»ºç½‘ç«™
      if: steps.check_changes.outputs.has_changes == 'true'
      run: hugo --minify
      
    - name: éƒ¨ç½²åˆ° Netlify
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './public'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "${{ github.event.inputs.deploy_message || 'å®šæ—¶éƒ¨ç½²' }} - $(date '+%Y-%m-%d %H:%M')"
        enable-pull-request-comment: false
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ ç½‘ç«™åœ°å€ï¼šhttps://chillinew.com"
        echo "â° éƒ¨ç½²æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"